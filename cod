import pandas as pd
import numpy as np
from tqdm import tqdm

# ---- Step 1: Define tenor to offset conversion ----
def tenor_to_offset(tenor):
    num = int(''.join(filter(str.isdigit, tenor)))
    unit = ''.join(filter(str.isalpha, tenor))
    if unit == 'g':  # gün (day)
        return pd.Timedelta(days=num)
    elif unit == 'a':  # ay (month)
        return pd.DateOffset(months=num)
    elif unit == 'y':  # yıl (year)
        return pd.DateOffset(years=num)
    else:
        raise ValueError(f"Unknown tenor format: {tenor}")

# ---- Step 2: Create mapping of column names to offsets ----
tenor_offsets = {col: tenor_to_offset(col) for col in df.columns}

# ---- Step 3: Interpolation function ----
def interpolate_row(start_date, row, horizon_years=5):
    # 1. Map known tenors to future dates
    known_dates = [start_date + tenor_offsets[col] for col in df.columns]
    known_values = row.values.astype(float)
    
    # 2. Create time series with known dates
    known_series = pd.Series(data=known_values, index=pd.to_datetime(known_dates)).sort_index()

    # 3. Generate business days up to 5 years ahead
    end_date = start_date + pd.DateOffset(years=horizon_years)
    bdays = pd.date_range(start=start_date, end=end_date, freq='B')

    # 4. Interpolate only on business days, keeping known values
    full_series = known_series.reindex(known_series.index.union(bdays)).sort_index()
    interpolated = full_series.interpolate(method='time')
    interpolated = interpolated.loc[bdays]

    # 5. Return a single-row DataFrame with date columns
    return pd.DataFrame([interpolated.values], columns=interpolated.index)

# ---- Step 4: Run for each row with tqdm ----
interpolated_dfs = []

for idx, row in tqdm(df.iterrows(), total=len(df), desc="Interpolating rows"):
    interpolated_df = interpolate_row(idx, row)
    interpolated_df.index = [idx]  # Name the row using its original date
    interpolated_dfs.append(interpolated_df)

# ---- Example: View one interpolated row ----
print(interpolated_dfs[0].iloc[:, :5])  # first 5 columns (dates)